---
tags:
  - study
  - ì´í™í‹°ë¸Œìë°”
title: ê³µìœ  ì¤‘ì¸ ê°€ë³€ ë°ì´í„°ëŠ” ë™ê¸°í™”í•´ ì‚¬ìš©í•˜ë¼
chapter: ì•„ì´í…œ 78
---
## ê³µìœ  ì¤‘ì¸ ê°€ë³€ ë°ì´í„°ëŠ” ë™ê¸°í™”í•´ ì‚¬ìš©í•˜ë¼

### í•µì‹¬
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê°€ë³€ ë°ì´í„°ë¥¼ ê³µìœ í•œë‹¤ë©´ ê·¸ ë°ì´í„°ë¥¼ ì½ê³  ì“°ëŠ” ë™ì‘ì€ ë°˜ë“œì‹œ ë™ê¸°í™” í•´ì•¼í•œë‹¤.
- ë™ê¸°í™” í•˜ì§€ ì•Šìœ¼ë©´ í•œ ìŠ¤ë ˆë“œê°€ ìˆ˜í–‰í•œ ë³€ê²½ì„ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë³´ì§€ ëª»í•  ìˆ˜ë„ ìˆë‹¤. 
- ê³µìœ ë˜ëŠ” ê°€ë³€ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ëŠ”ë° ì‹¤íŒ¨í•˜ë©´ ì‘ë‹µ ë¶ˆê°€ ìƒíƒœì— ë¹ ì§€ê±°ë‚˜ ì•ˆì „ ì‹¤íŒ¨ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆë‹¤. ì´ëŠ” ë””ë²„ê¹… ë‚œì´ë„ê°€ ê°€ì¥ ë†’ì€ ë¬¸ì œì— ì†í•œë‹¤. 
- ê°„í—ì ì´ê±°ë‚˜ íŠ¹ì • íƒ€ì´ë°ì—ë§Œ ë°œìƒí•  ìˆ˜ë„ ìˆê³ , `VM`ì— ë”°ë¼ í˜„ìƒì´ ë‹¬ë¼ì§€ê¸°ë„ í•œë‹¤. ë°°íƒ€ì  ì‹¤í–‰ì€ í•„ìš” ì—†ê³  ìŠ¤ë ˆë“œ ë¼ë¦¬ì˜ í†µì‹ ë§Œ í•„ìš”í•˜ë‹¤ë©´ `volatile` í•œì •ìë§Œìœ¼ë¡œ ë™ê¸°í™”í•  ìˆ˜ ìˆë‹¤. ë‹¤ë§Œ ì˜¬ë°”ë¡œ ì‚¬ìš©í•˜ê¸°ê°€ ê¹Œë‹¤ë¡­ë‹¤.

### Synchronized
- `synchronized` í‚¤ì›Œë“œëŠ” í•´ë‹¹ ë©”ì„œë“œë‚˜ ë¸”ë¡ì„ í•œë²ˆì— í•œ ìŠ¤ë ˆë“œì”© ìˆ˜í–‰í•˜ë„ë¡ ë³´ì¥í•œë‹¤.
- í•œ ìŠ¤ë ˆë“œë¥¼ ë³€ê²½í•˜ëŠ” ì¤‘ì´ë¼ì„œ ìƒíƒœê°€ ì¼ê´€ë˜ì§€ ì•Šì€ ìˆœê°„ì˜ ê°ì²´ë¥¼ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë³´ì§€ ëª»í•˜ê²Œ ë§‰ëŠ” ìš©ë„ë¡œë§Œ ìƒê°í•œë‹¤.
- ë™ê¸°í™”ë¥¼ ì¬ëŒ€ë¡œ í•˜ë©´ ì–´ë–¤ ë©”ì„œë“œë„ ì´ ê°ì²´ì˜ ìƒíƒœê°€ ì¼ê´€ë˜ì§€ ì•Šì€ ìˆœê°„ì„ ë³¼ìˆ˜ ì—†ì„ ê²ƒì´ë‹¤.
- ë™ê¸°í™”ì—ëŠ” ì¤‘ìš”í•œ ê¸°ëŠ¥ì´ í•˜ë‚˜ ë” ìˆë‹¤. ë™ê¸°í™” ì—†ì´ëŠ” í•œ ìŠ¤ë ˆë“œê°€ ë§Œë“  ë³€í™”ë¥¼ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ í™•ì¸í•˜ì§€ ëª»í•  ìˆ˜ ë„ìˆë‹¤. ì¦‰, ë™ê¸°í™”ëœ ë©”ì„œë“œë‚˜ ë¸”ë¡ì— ë“¤ì–´ê°„ ìŠ¤ë ˆë“œê°€ ê°™ì€ ë½ì˜ ë³´í˜¸í•˜ì— ìˆ˜í–‰ëœ ì´ì „ ìˆ˜ì •ì˜ ìµœì¢… ê²°ê³¼ë¥¼ ë³´ê²Œ í•´ì¤€ë‹¤.

### ì›ìì 
- ìë°” ì–¸ì–´ì˜ ëª…ì„¸ìƒìœ¼ë¡œ longê³¼ double ë¥¼ ì œì™¸í•œ ë³€ìˆ˜ë¥¼ ì½ê³  ì“°ëŠ” ê²ƒì€ ì›ìì ì´ë‹¤. ì¦‰, ë™ê¸°í™” ì—†ì´ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê°™ì€ ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ë”ë¼ë„ í•­ìƒ ì–´ë–¤ ìŠ¤ë ˆë“œê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥í•œ ê°’ì„ ì½ì–´ì˜¤ëŠ” ê²ƒì„ ë³´ì¥í•œë‹¤ëŠ” ê²ƒì´ë‹¤.
- í•˜ì§€ë§ŒÂ **ìŠ¤ë ˆë“œê°€ í•„ë“œë¥¼ ì½ì„ ë•Œ í•­ìƒ â€˜ìˆ˜ì •ì´ ì™„ì „íˆ ë°˜ì˜ëœâ€™ ê°’ì„ ì–»ëŠ”ë‹¤ ë³´ì¥**í•˜ì§€ë§Œ,Â **í•œ ìŠ¤ë ˆë“œê°€ ì €ì¥í•œ ê°’ì´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ê²Œ â€˜ë³´ì´ëŠ”ê°€â€™ëŠ” ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.**Â ë”°ë¼ì„œ ì›ìì  ë°ì´í„°ë¥¼ ì“¸ ë•Œë„ ë™ê¸°í™”í•´ì•¼ í•œë‹¤.

### ì˜ëª»ëœ ì½”ë“œ ì˜ˆì‹œ
```java
// 78-1
public class StopThread {
    private static boolean stopRequested;

    public static void main(String[] args) throws InterruptedException {
        Thread backgroundThread = new Thread(() -> {
            int i = 0;
            while (!stopRequested)
                i++;
        });
        backgroundThread.start();
        TimeUnit.SECONDS.sleep(1);
        stopRequested = true;
    }
}
```
- ë™ê¸°í™”ë¥¼ í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— `stopRequested` ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œê°€ ì–¸ì œì¯¤ í™•ì¸í•˜ëŠ”ì§€ ë³´ì¦í•  ìˆ˜ ì—†ë‹¤.
### synchronized ì‚¬ìš© ì˜ˆì‹œ
```java
// 78-2
public class StopThread {
    private static boolean stopRequested;

    private static synchronized void requestStop() {
        stopRequested = true;
    }

    private static synchronized boolean stopRequested() {
        return stopRequested;
    }

    public static void main(String[] args) throws InterruptedException {
        Thread backgroundThread = new Thread(() -> {
            int i = 0;
            while (!stopRequested())
                i++;
        });
        backgroundThread.start();
        TimeUnit.SECONDS.sleep(1);
        requestStop();
    }
}
```
- ì“°ê¸° ë©”ì„œë“œì™€ ì½ê¸° ë©”ì„œë“œ ëª¨ë‘ë¥¼ ë™ê¸°í™” í–ˆìŒì— ì£¼ëª©í•˜ì
- ì“°ê¸°ì™€ ì½ê¸° ëª¨ë‘ê°€ ë™ê¸°í™”ë˜ì§€ ì•Šìœ¼ë©´ ë™ì‘ì„ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
### volatile ì‚¬ìš© ì˜ˆì‹œ
```java
// 78-3
public class stopThread {
    private static volatile boolean stopRequested;

    public static void main(String[] args) throws InterruptedException {
        Thread backgroundThread = new Thread(() -> {
            int i = 0;
            while (!stopRequested)
                i++;
        });
        backgroundThread.start();
        TimeUnit.SECONDS.sleep(1);
        stopRequested = true;
    }
}
```
- ì†ë„ê°€ ë” ë¹ ë¥¸ ëŒ€ì•ˆì´ë‹¤.
- volatile í•œì •ìëŠ” ë°°íƒ€ì  ìˆ˜í–‰ê³¼ëŠ” ìƒê´€ì—†ì§€ë§Œ í•­ìƒ ê°€ì¥ ìµœê·¼ì— ê¸°ë¡ëœ ê°’ì„ ì½ê²Œ ë¨ì„ ë³´ì¥í•œë‹¤.

### volatile ì£¼ì˜ì‚¬í•­
```java
//78-4
private static volatile int nextSerialNumber = 0;

public static int generateSerialNumber() {
    return nextSerialNumber++;
}
```
- (GPT) `volatile`ì€ ë³€ìˆ˜ì˜ ê°€ì‹œì„±ë§Œ ë³´ì¥í• ë¿ ì—°ì‚°ì˜ ì›ìì„±ì„ ë³´ì¥í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤.
- (GPT) ì¦‰, `volatile`ì„ ì‚¬ìš©í•˜ë©´ **ë³€ìˆ˜ì˜ ê°’ì´ ì¦‰ì‹œ ëª¨ë“  ìŠ¤ë ˆë“œì— ë°˜ì˜ë˜ì§€ë§Œ**, **ì½ê³  ì“°ëŠ” ì—°ì‚°ì´ í•˜ë‚˜ì˜ ì›ìì ì¸ ë™ì‘ìœ¼ë¡œ ë³´ì¥ë˜ì§€ ì•Šì•„ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.**
	- (GPT) ì›ìì  ì—°ì‚°ì´ë€?
		- í•˜ë‚˜ì˜ ì—°ì‚°ì´ ë”ì´ìƒ ë‚˜ë‰  ìˆ˜ ì—†ëŠ” ìµœì†Œ ë‹¨ìœ„ë¡œ ì‹¤í–‰ë¨ì„ ì˜ë¯¸í•œë‹¤.
		- ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì´ ì—°ì‚°ì˜ ì¤‘ê°„ ìƒíƒœë¥¼ ë³¼ ìˆ˜ ì—†ë‹¤. ì—°ì‚°ì´ ì‹¤í–‰ë˜ë©´ í•œë²ˆì— ìˆ˜í–‰ë˜ì–´ì•¼ í•œë‹¤.
		- ì¹´ìš´íŠ¸++ ì—°ì‚°ì€ ì‹¤ì œë¡œ ê°’ì½ê¸°, ê°’ì¦ê°€, ê°’ì €ì¥ì„ ì‹¤í–‰í•œë‹¤. ì´ë•Œ ë‘ê°œì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ê°™ì€ ê°’ì„ ì½ê³  ì¦ê°€í•  ìˆ˜ ìˆë‹¤.
- `synchronized` ì“°ë©´ ë¬¸ì œê°€ í•¼ê²°ëœë‹¤. í•˜ì§€ë§Œ `volatile` ì„ ì œê±°í•´ì•¼í•œë‹¤.
```java
// ì›ìì ì´ì§€ ëª»í•œ ì½”ë“œ
public class VolatileIssue {  
    private static volatile int counter = 0; // ğŸ”¹ volatile ì‚¬ìš©  
  
    public static void main(String[] args) throws InterruptedException {  
        Thread t1 = new Thread(() -> {  
            for (int i = 0; i < 10000; i++) {  
                counter++; // ğŸš¨ ì›ìì ì´ì§€ ì•ŠìŒ  
            }  
        });  
  
        Thread t2 = new Thread(() -> {  
            for (int i = 0; i < 10000; i++) {  
                counter++; // ğŸš¨ ì›ìì ì´ì§€ ì•ŠìŒ  
            }  
        });  
  
        t1.start();  
        t2.start();  
        t1.join();  
        t2.join();  
  
System.out.println("Counter: " + counter); // âŒ 20000ì´ ì•„ë‹ ê°€ëŠ¥ì„±ì´ í¼!  
    }  
}
```

### Atomic
```java
public class AtomicExample {  
    private static AtomicInteger counter = new AtomicInteger(0); // âœ… AtomicInteger ì‚¬ìš©  
    public static void main(String[] args) throws InterruptedException {  
        Thread t1 = new Thread(() -> {  
            for (int i = 0; i < 10000; i++) {  
                counter.incrementAndGet(); // âœ… ì›ìì  ì¦ê°€  
            }  
        });  
  
        Thread t2 = new Thread(() -> {  
            for (int i = 0; i < 10000; i++) {  
                counter.incrementAndGet(); // âœ… ì›ìì  ì¦ê°€  
            }  
        });  
  
        t1.start();  
        t2.start();  
        t1.join();  
        t2.join();  
  
        System.out.println("Counter: " + counter.get()); // âœ… í•­ìƒ 20000 ë³´ì¥ë¨!  
    }  
}
```
- ë½ ì—†ì´ë„ ìŠ¤ë ˆë“œ ì•ˆì „í•œ í”„ë¡œê·¸ë˜ë°ì„ ì§€ì›í•œë‹¤.
- `volatile`ì€ ë™ê¸°í™” ë‘ íš¨ê³¼ì¤‘ í†µì‹ ìª½ë§Œ ì§€ì›í•˜ì§€ë§Œ ì´ íŒ¨í‚¤ì§€ëŠ” ì›ìì„±ê¹Œì§€ ì§€ì›í•œë‹¤.

### ExecutorService
```java
 public static void main(String[] args) throws InterruptedException {  
        /**  
         * runnable ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•œ thread  
         *///        int THREAD_COUNT = Runtime.getRuntime().availableProcessors();  
//        int taskCount = 10000; // ì´ ì‘ì—… ê°œìˆ˜  
//        List<Store> storeList = new ArrayList<>();  
//  
//        // 1. ë°ì´í„° ìƒì„±  
//        for (int i = 0; i < taskCount; i++) {  
//            storeList.add(new Store("V" + i, LocalDate.now().minusDays(new Random().nextInt(5))));  
//        }  
//  
//        // 2. ì‹¤í–‰ ì‹œê°„ ì¸¡ì •  
//        long startTime = System.nanoTime();  
//  
//        // 3. ë©€í‹° ìŠ¤ë ˆë“œ ì‹¤í–‰  
//        List<Thread> threads = new ArrayList<>();  
//        for (Store store : storeList) {  
//            Thread thread = new Thread(new StoreUpdateTask(store));  
//            threads.add(thread);  
//            thread.start();  
//  
//            // ğŸ”¹ ê³¼ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•´ ì¼ì • ê°œìˆ˜ë§Œí¼ ì‹¤í–‰ í›„ ëŒ€ê¸°  
//            if (threads.size() >= THREAD_COUNT) {  
//                for (Thread t : threads) {  
//                    t.join();  
//                }  
//                threads.clear();  
//            }  
//        }  
//  
//        // 4. ë‚¨ì€ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°  
//        for (Thread thread : threads) {  
//            thread.join();  
//        }  
//  
//        long endTime = System.nanoTime();  
//        System.out.println("ë©€í‹° ìŠ¤ë ˆë“œ ì‹¤í–‰ ì‹œê°„: " + (endTime - startTime) / 1_000_000 + " ms");  
//  
//        // 5. ê²°ê³¼ ì¶œë ¥ (ì¼ë¶€ë§Œ í™•ì¸)  
//        storeList.stream()  
//                .filter(store -> "Y".equals(store.yn))  
//                .limit(10)  
//                .forEach(System.out::println);  
        /**  
         * ExecutorService í™œìš©í•œ ë°©ì‹. gpt ë§ë¡œëŠ” íš¨ìœ¨ì´ ë” ì¢‹ë‹¤ê³ í•¨  
         */  
        int THREAD_COUNT = Runtime.getRuntime().availableProcessors();  
        ExecutorService executor = Executors.newFixedThreadPool(THREAD_COUNT);  
  
        // 1. ë°ì´í„° ìƒì„± (10,000ê°œ)  
        List<Store> storeList3 = new ArrayList<>();  
        for (int i = 0; i < 10000; i++) {  
            storeList3.add(new Store("V" + i, LocalDate.now().minusDays(new Random().nextInt(5))));  
        }  
  
        //  ExecutorService ë°©ì‹ ì‹¤í–‰ ì‹œê°„ ì¸¡ì •  
        long start3 = System.currentTimeMillis();  
        List<Future<Void>> futures = new ArrayList<>();  
        for (Store store : storeList3) {  
            futures.add(executor.submit(() -> {  
                /**  
                 * db ë¥¼ ì‚¬ìš©í•˜ëŠ” ìƒí™©ì´ë¼ë©´ mapperë¥¼ í˜¸ì¶œí•˜ëŠ” ë©”ì„œë“œë¥¼ í•˜ë‚˜ë” ìƒì„±í•˜ê³  
                 * @Transactional ì„ ì´ìš©í•˜ì—¬ ë©€í‹° ìŠ¤ë ˆë“œì—ì„œ ì •ìƒì ìœ¼ë¡œ ì ìš©ë˜ê²Œ í•´ì•¼í•œë‹¤.  
				 **/                
				 store.checkAndUpdate();  
                return null;            
                }));  
        }  
  
        // ëª¨ë“  ì‘ì—… ì™„ë£Œ ëŒ€ê¸°  
        for (Future<Void> future : futures) {  
            try {  
                future.get();  
            } catch (ExecutionException e) {  
                e.printStackTrace();  
            }  
        }  
  
        long end3 = System.currentTimeMillis();  
        System.out.println("ExecutorService ì‹¤í–‰ ì‹œê°„: " + (end3 - start3) + "ms");  
  
        executor.shutdown();  
        executor.awaitTermination(10, TimeUnit.SECONDS);  
  
  
  
        /**  
         * ë‹¨ìˆœ ë°˜ë³µë¬¸  
         */  
//        List<Store> storeList2 = new ArrayList<>();  
//        int taskCount2 = 10000; // ì´ ì‘ì—… ê°œìˆ˜  
//  
//        // 1. ë°ì´í„° ìƒì„±  
//        for (int i = 0; i < taskCount2; i++) {  
//            storeList2.add(new Store("V" + i, LocalDate.now().minusDays(new Random().nextInt(5))));  
//        }  
//  
//        // 2. ì‹¤í–‰ ì‹œê°„ ì¸¡ì •  
//        long startTime2 = System.nanoTime();  
//  
//        // 3. ë‹¨ìˆœ ë°˜ë³µë¬¸ ì‹¤í–‰ (ìˆœì°¨ ì‹¤í–‰)  
//        for (Store store : storeList2) {  
//            store.checkAndUpdate();  
//        }  
//  
//        long endTime2 = System.nanoTime();  
//        System.out.println("ìˆœì°¨ ì‹¤í–‰ ì‹œê°„: " + (endTime2 - startTime2) / 1_000_000 + " ms");  
//  
//        // 4. ê²°ê³¼ ì¶œë ¥ (ì¼ë¶€ë§Œ í™•ì¸)  
//        storeList2.stream()  
//                .filter(store -> "Y".equals(store.yn))  
//                .limit(10)  
//                .forEach(System.out::println);  
    }  
  
}
```
- `ExecutorService` ëŠ” ìŠ¤ë ˆë“œë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ ê´€ë¦¬ë¥¼ í•´ì¤Œ <-> ì‚¬ìš©ìê°€ ì§ì ‘ê´€ë¦¬
- ìŠ¤ë ˆë“œë¥¼ ì¬ì‚¬ìš©í•˜ë¯€ë¡œ ìì›ë‚­ë¹„ê°€ ì ìŒ <-> ê³¼ë„í•œ ìŠ¤ë ˆë“œ ìƒì„±ìœ¼ë¡œ ì„±ëŠ¥ì €í•˜ ê°€ëŠ¥
- `Future` ê°ì²´ë¥¼ í†µí•´ ì˜ˆì™¸ë¥¼ ì‰½ê²Œ ì²˜ë¦¬ê°€ëŠ¥ <-> ê°œë³„ ìŠ¤ë ˆë“œì—ì„œ ì˜ˆì™¸ ë°œìƒì‹œ ì²˜ë¦¬ ì–´ë ¤ì›€
- ì ì ˆí•œ ê°œìˆ˜ì˜ ìŠ¤ë ˆë“œ ìœ ì§€ë¡œ íš¨ìœ¨ì ìœ¼ë¡œ ì‹¤í–‰ <-> ì˜¤ë²„í•´ë“œ ë°œìƒê°€ëŠ¥ì„±ìˆìŒ
- ë‹¨, ê°„ë‹¨í•œ ì‘ì—…ì—ì„œëŠ” ì˜¤íˆë ¤ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆë‹¤.
- ì‹¤ì œ ìœ„ ì½”ë“œ ì‹¤í–‰í•´ë³¸ê²°ê³¼ë¡œëŠ” `ExecutorService` ì˜ ì„±ëŠ¥ì´ 16ë°°ì •ë„ ì¢‹ì•˜ìŒ