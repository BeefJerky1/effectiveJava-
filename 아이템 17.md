---
tags:
  - study
  - 이펙티브자바
title: 변경 가능성을 최소화하라
chapter: 아이템 17
---
## 변경 가능성을 최소화하라

- 불변 클래스란 인스턴스의 내부 값을 수정 할 수 없는 클래스를 말한다.
- 불변 인스턴스에 간직된 정보는 고정되어 파괴되는 순간까지 절대 달라지지 않는다.
- 불변 클래스는 가변 클래스보다 설계하고 구현하고 사용하기 쉬우며, 오류가 생길 여지도 적고 훨씬 안전하다.
### 불변 클래스를 만들기 위한 5가지 규칙
1. 객체의 상태를 변경하는 메서드(변경자)를 제공하지 않는다.
	- setter 메서드를 제공하지 않아야한다. 객체의 상태는 생성 시점에만 설정되고, 이후에는 변경될 수 없다.
2. 클래스를 확장할 수 없도록 한다.
	- 하위 클래스에서 부주의하게 혹은 나쁜의도로 객체 상태를 변경하는 것을 막는다.
	- 상속을 막는 대표적인 방법은 클래스를 final로 선언하는 것이지만 다른 방법도 있다.
3. 모든 필드를 final로 선언한다.
	- 필드가 생성자에서 한 번만 할당될 수 있고, 이후에는 그 값이 변경될 수 없다.
4. 모든 필드를 private으로 선언한다.
	- private으로 선언함으로써 클래스 외부에서 직접 접근할 수 없게한다.
5. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.
	- 클래스에 가변 객체를 참조하는 필드가 하나라도 있다면 클라이언트에서 그 객체의 참조를 얻을 수 없도록 해야 한다. 가변 객체를 참조하는경우 해당 참조를 직접 노출하지 않고 방어적 복사를 통해 반환해야 한다.
```java
import java.util.Date;

public final class ImmutableEvent {
    private final String name;
    private final Date date; // 가변 객체

    public ImmutableEvent(String name, Date date) {
        this.name = name;
        this.date = new Date(date.getTime()); // 방어적 복사
    }

    public String getName() {
        return name;
    }

    public Date getDate() {
        return new Date(date.getTime()); // 방어적 복사
    }
}
```


## 불변 클래스의 장점

#### 불변 객체는 단순하다.
- 생성된 시점의 상태를 파괴될때까지 그대로 간직한다.
#### 불변 객체는 근복적으로 스레드 안전하여 따로 동기화할 필요없다.
- 여러 스레드가 동시에 사용해도 절대 훼손되지 않는다.
- 클래스를 스레드 안전하게 만드는 가장 쉬운 방법
#### 불변 객체는 안심하고 공유할 수 있다.
- `public static final` 상수로 만들어 재활용할 수 있다
- 자주 사용되는 인서턴스를 캐싱하여 같은 인서턴스를 중복 생성하지 않게 해주는 정적 펙터리 메소드를 제공할 수 있다.
- 이방법을 사용하면 메모리 사용량과 가비지 컬렉션 비용이 줄어든다.
#### 불변 객체끼리는 **내부 데이터를 공유**할 수 있다.
- `BigInteger`는 값의 부호는 `int`를 크기는 `int[]`를 사용하는데 크기가 같고 부호만 반대인 새로운 `BigInteger`를 생성하는 `negate()`는 원본과 크기를 공유한다.
#### **객체를 만들 때 다른 불변 객체들을 구성요소**로 사용하면 아무리 복잡한 구조라도 불변식을 유지하기 훨씬 수월하다.
- - `Map`, `Set`의 원소로 쓰기에 안성맞추미다.
#### 불변 객체는 **실패 원자성**을 제공한다.
- 실패의 원자성이란 메서드에서 예외가 발생한 후에도 그 객체는 여전히 메서드 호출전과 똑같은 유효한 상태여야 한다는 성질이다. 
- 불변 객체는 내부 상태를 바꾸지 않으니 이 성질을 만족한다.

## 불변 클래스의 단점

### 값이 다르면 반드시 독립된 객체로 만들어야하 한다.
- 값의 가짓수가 많다면 모두 만드는데 비용이 들어감
- 해결책이 이싿. 객체를 완성하기까지의 단계에서 쓰일 **다단계 연산**을 예측하여 제공해주는 것이다. 이를 **가변 동반 클래스**라고 한다.
- `String`을 예시로 들자면 `StringBuilder`와 `StringBuffer`가 있다.

### 불변 클래스 설계
- 클래스가 불변임을 보장하기 위해 final로 선언하는 것보다 유연한 방법이 있다.
- **모든 생성자를 `private` or `package-private`로 만들고 `public 정적 팩토리`를 제공하는 방법이다.**
```java
public class Complex {

    private final double re;
    private final double im;

    private Complex(double re, double im) {
        this.re = re;
        this.im = im;
    }

    public static Complex valueOf(double re, double im) {
        return new Complex(re, im);
    }
}
```